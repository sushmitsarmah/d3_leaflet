<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <link rel="stylesheet" type="text/css" href="libs/leaflet/dist/leaflet.css">
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head>
  <body>
  <div id='map'></div>


  <script type="text/javascript" src='libs/leaflet/dist/leaflet.js'></script>
  <script type="text/javascript" src='libs/d3/d3.min.js'></script>
  <script type="text/javascript" src='libs/underscore/underscore-min.js'></script>
  <script type="text/javascript">

	// add an OpenStreetMap tile layer
	var thunderforest = L.tileLayer('http://{s}.tile.thunderforest.com/landscape/{z}/{x}/{y}.png', { attribution: '&copy; <a href="http://thunderforest.com/copyright">ThunderForest</a> contributors'
	});

	var openstreet = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
	});	

	// create a map in the "map" div, set the view to a given place and zoom
	// var map = L.map('map').setView([46.64, -94.83], 10);
	var map = L.map('map', {
		center: [46.64, -94.83],
		zoom: 10,
		layers: [thunderforest,openstreet]
	});

	var baseMaps = {
	    "ThunderForest": thunderforest,
	    "OpenStreetMap": openstreet
	};

	var point = L.point(6, 6);

	var myIcon = L.divIcon({className:'circle', iconSize:point});

	//Load cellular data
  	d3.csv('data/cellular.csv',function(d){

  		['LAT_DMS','LON_DMS'].forEach(function(dms){
  			d[dms] = d[dms].split(',')
  					.reduce(function(a,b,i){
  						b = i == 1 ? b/60 : b/3600;
  						return +a+b;
  					});
  		});

  		d.LAT_DMS *= d.LATDIR == 'S' ? -1:1;
  		d.LON_DMS *= d.LONDIR == 'W' ? -1:1; 
  		d.SUPSTRUC = +d.SUPSTRUC;
  		d.ALLSTRUC = +d.ALLSTRUC;

  		return d;					

  	}, function(err,data){

  		// add a marker in the given location, attach some popup content to it and open the popup
  		var licensees = _.uniq(_.pluck(data,'LICENSEE')),
  			overlays = {};

  		licensees.forEach(function(lic){
  			var layerGroup = [],
  				temp_data = data.filter(function(d){
  					return d.LICENSEE == lic;
  				});

	  		temp_data.forEach(function(d){
				layerGroup.push( L.marker([d.LAT_DMS, d.LON_DMS], {icon: myIcon}).bindPopup(d.LOCADD+','+d.LOCCITY+','+d.LOCCOUNTY) );
	  		});

	  		var group = L.layerGroup(layerGroup);

	  		overlays[lic] = group;

  		});

  		L.control.layers(baseMaps, overlays).addTo(map);


  	});



  </script>

  </body>
</html>